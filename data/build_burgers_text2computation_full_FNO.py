import h5py
import json
import numpy as np
import random
from pathlib import Path


# ========== 1. 基本配置 ==========
H5_PATH = Path(r".\data\1D_Burgers_Sols_Nu1.0.hdf5")
OUTPUT_JSONL = Path("burgers_text2computation_full_FNO.jsonl")

# 历史两个时间步：这里用前两个时间点
T0_IDX = 0  # 第一个时间步
T1_IDX = 1  # 第二个时间步

# k（目标时间步）如何选：
# True  => 随机从 [T1_IDX+1, T-1] 里选一个，模拟多步滚动
# False => 固定用下一步（k = T1_IDX + 1），只做 one-step
USE_RANDOM_K = True

# 每种模板对应的样本条数：你说的是“每种模板 100 个样例”
NUM_SAMPLES_PER_TEMPLATE = 100



# ========== 2. 工具函数：数值数组转字符串 ==========

def array_to_str(arr: np.ndarray) -> str:
    """
    把一维数组变成 '0.123456, 0.234567, ...' 的字符串，
    用在 prompt 里展示 1024 个数。
    """
    return ", ".join(f"{v:.6f}" for v in arr)


# ========== 3. 文本模板：需要你在这里补满 100 条 ==========

# 3.1 普通模板（不纠错）
# 使用占位符：
# {T0}, {T1}, {Tk}, {U_T0}, {U_T1}
TEMPLATES_NORMAL_BURGERS = [
    # 1
    (
        "这是一条来自一维 Burgers 方程的数值模拟样本。在两个历史时间步上的一维速度场已经给出："
        "在时间步 {T0} 时，沿 1024 个空间点的流体速度为：{U_T0}；在时间步 {T1} 时，沿 1024 个空间点的流体速度为：{U_T1}。"
        "空间方向在 0 到 1 区间上均匀划分为 1024 个网格点。"
        "请根据这两个时间步的速度场信息，给出其下一时间步在 1024 个空间点上的速度场数值解。"
    ),
    # 2
    (
        "对于这一条一维 Burgers 方程轨迹，我们已经知晓在时间 {T0} 和 {T1} 上的流体速度场，"
        "它们分别在 1024 个空间网格上取样：t={T0} : {U_T0}；t={T1} : {U_T1}。"
        "这些空间网格在 [0,1] 区间上均匀分布。"
        "请在只给定前两个时间帧的前提下，预测下一帧在 1024 个空间节点上的速度场分布。"
    ),
    # 3
    (
        "考虑一维 Burgers 方程的数值解。对当前这条样本，我们给出了两个已知时间步的速度场："
        "在 t={T0} 时的 1024 维速度为：{U_T0}；在 t={T1} 时的 1024 维速度为：{U_T1}。"
        "每一个速度值都对应 [0,1] 区间上均匀划分得到的 1024 个空间点之一。"
        "请利用这两帧数据，预测其下一时间步在 1024 个空间位置上的速度场。"
    ),
    # 4
    (
        "对一维 Burgers 方程的这条轨迹，我们已知在时间步 {T0} 和 {T1} 的解，分别是 1024 维速度数组：{U_T0} 和 {U_T1}。"
        "空间方向被离散成 1024 个等间距网格，覆盖 0 至 1 的区间。"
        "现在希望获得下一时间步的速度场。请根据已有的两帧历史信息，给出该时间步在全部 1024 个空间点上的流体速度分布。"
    ),
    # 5
    (
        "这是一个一维 Burgers 方程演化过程的数值结果。前两帧历史速度场分别对应时间 {T0} 和 {T1}，其在 1024 个空间位置上的取值为："
        "t={T0} : {U_T0}；t={T1} : {U_T1}。"
        "这些空间位置是在 0 到 1 区间上等间距选取的 1024 个点。"
        "请据此推断下一时间步在 1024 个空间点上的速度场预测值。"
    ),
    # 6
    (
        "对于当前的一维 Burgers 方程样本，数值解在两个时刻 t={T0} 和 t={T1} 已经给出，"
        "两帧在 1024 个空间位置上的速度值分别列为：{U_T0} 和 {U_T1}。"
        "这里的 1024 个空间点均匀地覆盖 0 到 1 的区间。"
        "请在此基础上估计下一帧在 1024 个空间网格点上的速度场。"
    ),
    # 7
    (
        "我们对一维 Burgers 方程进行了离散求解。对于某条轨迹，已知 t={T0} 和 t={T1} 时刻的速度场解，"
        "在 1024 个网格点上的速度分别为 {U_T0} 与 {U_T1}。"
        "这些网格点在空间方向上是 0 到 1 区间的均匀划分。"
        "现希望得到下一时间步在 1024 个空间位置上的速度场数值，请给出对应结果。"
    ),
    # 8
    (
        "在这一 Burgers 方程样本中，前两帧解已知：时间步 {T0} 对应的 1024 维速度数组为 {U_T0}，时间步 {T1} 对应的 1024 维速度数组为 {U_T1}。"
        "每一维速度对应的是 0 到 1 区间上一个等间距空间网格点。"
        "请在此基础上，预测下一帧在全部 1024 个空间点上的流体速度场。"
    ),
    # 9
    (
        "给定一维 Burgers 方程的数值轨迹，对当前样本而言，在时间步 {T0} 和 {T1} 上的速度场分别采样为 1024 维向量：{U_T0} 与 {U_T1}。"
        "这些采样点是对空间区间 [0,1] 的均匀划分。"
        "请利用这两帧历史状态，预测下一时间步在 1024 个空间格点上的速度场分布。"
    ),
    # 10
    (
        "这是一个一维 Burgers 方程的时间序列样本。我们已经获得了两个历史时间步 {T0} 和 {T1} 上的解："
        "在 1024 个空间位置上的速度取值依次为 {U_T0} 和 {U_T1}。"
        "这些位置对应 0 到 1 区间上等间距的 1024 个网格点。"
        "请给出该样本在下一时间步的 1024 维速度场解。"
    ),
    # 11
    (
        "在一维 Burgers 方程中，流体速度场随时间演化。对当前这条轨迹，时间步 {T0} 和 {T1} 的速度场已知，"
        "在 1024 个网格点上的值分别为 {U_T0} 与 {U_T1}。"
        "这里的网格点将 0 到 1 的空间区间均匀划分成 1024 份。"
        "现请根据这两帧历史解，预测下一时间步在 1024 个格点上的速度场。"
    ),
    # 12
    (
        "考虑一维 Burgers 方程的离散模拟结果，对某条样本而言，我们已知在时间 {T0} 与 {T1} 上的 1024 维速度解：{U_T0} 和 {U_T1}。"
        "解向量的每个分量对应的是 0 到 1 区间上一个等间距的空间位置。"
        "请在只给定这两帧信息的前提下，输出下一时间步的 1024 维速度场预测。"
    ),
    # 13
    (
        "对于这条一维 Burgers 方程样本，t={T0} 和 t={T1} 时刻的数值解在 1024 个空间点上已知："
        "t={T0} : {U_T0}；t={T1} : {U_T1}。"
        "这些空间点在 [0,1] 区间上均匀排列。"
        "请根据前两帧解，预测下一时间步时刻在 1024 个空间格点上的速度场。"
    ),
    # 14
    (
        "我们分析一维 Burgers 方程的这一条数值轨迹，已知两个历史时间步 {T0} 与 {T1} 上 1024 个网格点的解分别为 {U_T0} 和 {U_T1}。"
        "网格点在空间方向上把 0 到 1 的区间等分成 1024 段。"
        "现在希望获得下一时间步的数值解，请输出该时间步在 1024 个空间点上的速度场。"
    ),
    # 15
    (
        "对当前的一维 Burgers 方程样本，数值解在两个时刻 t={T0} 和 t={T1} 已经给出，"
        "在 1024 个空间位置上的速度取值分别列为：{U_T0} 和 {U_T1}。"
        "这些位置对应的是 0 到 1 区间的等间距网格。"
        "请利用这两帧历史状态，预测下一帧在 1024 个空间点上的速度场。"
    ),
    # 16
    (
        "Burgers 方程的速度场会随时间演化并发生非线性变形。对这条样本，我们已知 t={T0} 与 t={T1} 的解分别为 1024 维向量：{U_T0}、{U_T1}。"
        "对应的空间坐标是在 [0,1] 区间上均匀离散得到的 1024 个点。"
        "请基于这两帧数据，给出下一时间步在所有 1024 个空间位置上的速度场。"
    ),
    # 17
    (
        "针对该一维 Burgers 方程样本，在时间 {T0} 与 {T1} 上的空间速度分布已经通过数值方法求出，"
        "对应 1024 个网格点的取值为：{U_T0} 和 {U_T1}。"
        "这些网格点均匀分布在 0 到 1 区间。"
        "如果我们希望得到下一时间步的速度场，请给出其在 1024 个空间点上的数值。"
    ),
    # 18
    (
        "下列数据来自一维 Burgers 方程的数值解：时间步 {T0} 的 1024 维速度场为 {U_T0}，时间步 {T1} 的 1024 维速度场为 {U_T1}。"
        "场值是在 0 到 1 区间上等间距布置的 1024 个空间点上采样得到的。"
        "请根据这两帧历史状态，推断下一帧在 1024 个空间点上的速度场。"
    ),
    # 19
    (
        "对于给定的这条 Burgers 轨迹，我们在时间步 {T0} 和 {T1} 上的速度场观测结果分别为：{U_T0} 与 {U_T1}（共 1024 个空间点）。"
        "这些空间点构成了 [0,1] 区间上的均匀网格。"
        "请利用这两帧历史解，给出下一时间步在 1024 个空间格点上的速度场数值解。"
    ),
    # 20
    (
        "我们掌握了当前 Burgers 方程样本在两个时间步上的速度分布：第一个时间步 {T0} 的 1024 个空间点速度为 {U_T0}，"
        "第二个时间步 {T1} 的 1024 个空间点速度为 {U_T1}。"
        "这些空间点均匀覆盖 0 到 1 的区间。"
        "请预测下一时间步在所有 1024 个空间点上的速度场结果。"
    ),
    # 21
    (
        "对于该一维 Burgers 方程数值轨迹，我们已记录在时间步 {T0} 与 {T1} 的 1024 维解：在 1024 个空间点上的速度分别是 {U_T0} 和 {U_T1}。"
        "解是定义在 [0,1] 上均匀取点的网格上的。"
        "请给出该样本在下一时间步的 1024 维速度场。"
    ),
    # 22
    (
        "在此一维 Burgers 方程问题中，我们提供两帧历史解：t={T0} 和 t={T1} 的 1024 维速度场分别为 {U_T0} 与 {U_T1}。"
        "对应的空间坐标是在 0 到 1 区间上等间距划分的 1024 个网格点。"
        "请在只使用这两帧信息的前提下，预测下一帧的速度场，在 1024 个空间离散点上的数值。"
    ),
    # 23
    (
        "下述是一维 Burgers 方程的一条轨迹片段。时间步 {T0} 的解在 1024 个空间点的速度为 {U_T0}，时间步 {T1} 的解为 {U_T1}。"
        "这些空间点是对 [0,1] 区间的均匀离散。"
        "请利用这两帧初始速度场信息，预测下一时间步的 1024 维速度场。"
    ),
    # 24
    (
        "已知一维 Burgers 方程某条轨迹在 t={T0} 和 t={T1} 的数值解，"
        "在 1024 个空间位置上的速度值分别记录为：{U_T0}、{U_T1}。"
        "这里的 1024 个位置在空间方向上等距布置于 0 到 1 区间。"
        "请给出此轨迹在下一时间步的 1024 个空间点上的速度场。"
    ),
    # 25
    (
        "对于这条 Burgers 样本，两个历史时间步 {T0} 和 {T1} 的速度场已经求出，长度为 1024 的向量分别为 {U_T0} 和 {U_T1}。"
        "这两个向量的分量都对应 0 到 1 区间上均匀划分的 1024 个网格点。"
        "请估计下一时间步对应的 1024 维速度场解。"
    ),
    # 26
    (
        "在一维 Burgers 方程的数值模拟中，我们只观测到了两个历史时刻的速度场：t={T0} 时的 1024 个数值为 {U_T0}，"
        "t={T1} 时的 1024 个数值为 {U_T1}。"
        "这些数值是在空间方向 0 到 1 区间上均匀取点得到的。"
        "请在此基础上，预测下一时间步的 1024 个空间格点上的速度场。"
    ),
    # 27
    (
        "对当前的 Burgers 方程轨迹，两个历史时间步的数值解已知，"
        "在 1024 个离散空间点上的结果分别为：{U_T0}（对应 {T0}），{U_T1}（对应 {T1}）。"
        "这些离散点将 [0,1] 区间均匀划分。"
        "如果我们向前演化一步，请给出下一时间步的 1024 维速度场。"
    ),
    # 28
    (
        "这是一维 Burgers 方程的一个测试样本。我们给出 t={T0} 和 t={T1} 的数值解，"
        "即 {U_T0} 与 {U_T1}，每个包含 1024 个空间点的速度。"
        "对应的 1024 个空间点在 0 到 1 区间上等间距分布。"
        "现在请给出下一时间步在 1024 个空间点上的速度场预测。"
    ),
    # 29
    (
        "下面的数组描述了一维 Burgers 方程的两帧历史解：t={T0} 时的 1024 维速度为 {U_T0}，t={T1} 时的 1024 维速度为 {U_T1}。"
        "解是在 0 到 1 区间上均匀取点的 1024 个空间位置上计算得到的。"
        "请根据这两帧数据，推断下一帧的 1024 维速度场。"
    ),
    # 30
    (
        "我们考虑一维 Burgers 方程的一段演化历史。两个已知时间步 {T0}、{T1} 的速度场已知，分别为长为 1024 的数组 {U_T0} 和 {U_T1}。"
        "其中每个数组的分量都对应 0 到 1 区间上的一个等距网格点。"
        "现在希望推断下一时间步时 1024 个空间点上的速度场，请给出对应的预测结果。"
    ),
    # 31
    (
        "Burgers 方程的解会随时间和空间共同变化。我们已在 t={T0} 和 t={T1} 的 1024 个离散空间点上记录了速度场 {U_T0} 和 {U_T1}。"
        "这些空间点构成了 [0,1] 区间的均匀网格。"
        "请基于这两帧记录，预测下一帧在 1024 个空间点上的速度场。"
    ),
    # 32
    (
        "这是一个一维 Burgers 方程的数值样本。输入条件是两个时间步 {T0} 与 {T1} 的速度场："
        "在 1024 个空间点上的数值序列分别为 {U_T0} 和 {U_T1}。"
        "空间坐标在 0 到 1 区间上采用 1024 个均匀网格点取样。"
        "请根据这两帧历史状态，预测下一时间步的 1024 维速度场。"
    ),
    # 33
    (
        "在这条 Burgers 轨迹中，时间步 {T0} 和 {T1} 的 1024 维速度场已经计算出来：{U_T0} 与 {U_T1}。"
        "这些场值附着在 [0,1] 区间均匀划分的 1024 个空间点上。"
        "请在此基础上，给出下一时间步在每个空间格点上的速度场预测。"
    ),
    # 34
    (
        "当前样本来自一维 Burgers 方程数值求解。已知在时间步 {T0} 的 1024 个空间点上速度为 {U_T0}，"
        "在时间步 {T1} 的 1024 个空间点上速度为 {U_T1}。"
        "这些空间点均匀覆盖了 0 到 1 的区间。"
        "请给出下一时间步的 1024 维速度场解。"
    ),
    # 35
    (
        "对于这一维 Burgers 方程样本，两个时间步 {T0} 与 {T1} 的解在 1024 个空间点上分别为 {U_T0} 与 {U_T1}。"
        "空间方向采用等间距网格，将 0 到 1 区间划分为 1024 个点。"
        "请你根据这两帧数据，预测下一时间步在 1024 个空间格点上的速度场。"
    ),
    # 36
    (
        "我们手头有一个 Burgers 方程数值结果，记录了 t={T0} 与 t={T1} 的 1024 维解：{U_T0} 和 {U_T1}。"
        "每个解向量对应的是 0 到 1 区间上均匀分布的 1024 个空间坐标。"
        "现在需要得到下一时间步的解。请基于这两帧历史状态输出该时间步在所有 1024 个空间位置上的速度场。"
    ),
    # 37
    (
        "下列两个数组给出了一维 Burgers 方程样本在时间步 {T0} 和 {T1} 时的数值解，各包含 1024 个空间离散点的速度：{U_T0} 与 {U_T1}。"
        "这些离散点将空间区间 [0,1] 均匀划分。"
        "请根据这两帧历史状态，预测下一时间步在全部 1024 个空间点上的速度场。"
    ),
    # 38
    (
        "对于此 Burgers 样本，我们已经得到 t={T0} 和 t={T1} 的离散解，记为 {U_T0}、{U_T1}（长度均为 1024）。"
        "对应的空间坐标是 0 到 1 区间上的等距网格点。"
        "请外推到下一时间步，给出该时刻在 1024 个空间点上的速度数值解。"
    ),
    # 39
    (
        "以下是一维 Burgers 方程的一条离散轨迹，在时间步 {T0} 与 {T1} 的解分别为：{U_T0} 和 {U_T1}。"
        "这些解是在 [0,1] 上均匀划分为 1024 个网格点后，在每个位置上计算得到的。"
        "请利用这两帧信息，预测下一帧的 1024 维速度场。"
    ),
    # 40
    (
        "我们正在研究一条一维 Burgers 方程的解轨迹。t={T0} 和 t={T1} 的速度场已经采样成两个 1024 维向量 {U_T0} 和 {U_T1}，"
        "它们分别对应空间方向 [0,1] 区间中 1024 个等间距网格点。"
        "请基于这两帧历史状态，给出下一时间步在所有 1024 个空间网格点上的速度场数值解。"
    ),
]

TEMPLATES_VAL_ERROR_BURGERS = [
    # 1
    (
        "这是一条一维 Burgers 方程样本。在时间步 {T0}，初始记录的 1024 个空间点速度场为：{U_T0_WRONG}。"
        "空间方向在 0 到 1 区间上均匀划分为 1024 个网格点，每个分量对应一个网格位置的流体速度。"
        "其中第 {IDX} 个空间网格点的速度被错误地写成了 {VAL_WRONG}，实际应该是 {VAL_TRUE}。"
        "在时间步 {T1}，速度场为：{U_T1_WRONG}。"
        "现以更正后的数值为准。请根据修正后的 t={T0} 与 t={T1} 两帧信息，预测其下一时间步在 1024 个空间位置上的速度场。"
    ),
    # 2
    (
        "对一维 Burgers 方程的某条轨迹，我们给出了两个历史时间步的速度场："
        "t={T0} 时的 1024 个速度值为：{U_T0_WRONG}，t={T1} 时的 1024 个速度值为：{U_T1_WRONG}。"
        "这些速度值是在空间方向 [0,1] 区间上均匀取的 1024 个网格点上得到的。"
        "在最初的记录中，时间步 {T0} 第 {IDX} 个空间点被记成 {VAL_WRONG}，经校对后确认应为 {VAL_TRUE}，上面的列表已经使用修正值。"
        "请在修正后的历史帧基础上，给出该样本在下一时间步中 1024 个空间离散点上的速度场预测结果。"
    ),
    # 3
    (
        "根据一维 Burgers 方程的数值解，我们得到 t={T0} 与 t={T1} 两个时间步上的速度场："
        "t={T0} : {U_T0_WRONG}；t={T1} : {U_T1_WRONG}。"
        "每一帧解都定义在 0 到 1 区间上等间距的 1024 个空间网格点上。"
        "需要注意的是，t={T0} 时第 {IDX} 个空间网格点的观测受到干扰，原速度 {VAL_WRONG} 应修正为 {VAL_TRUE}。"
        "请在采用修正后数据的前提下，预测下一时间步在 1024 个空间节点上的速度场。"
    ),
    # 4
    (
        "下列为一维 Burgers 方程在两个时间步的速度场数据：t={T0} : {U_T0_WRONG}，t={T1} : {U_T1_WRONG}。"
        "这里的 1024 个空间点是对 [0,1] 区间的均匀划分，因此各个点之间的间距相同。"
        "由于标定错误，t={T0} 时第 {IDX} 个空间点的速度 {VAL_WRONG} 实际上应为 {VAL_TRUE}。"
        "请利用修正后的历史两帧，给出下一时间步在 1024 个空间点上的速度场解。"
    ),
    # 5
    (
        "对该一维 Burgers 方程样本，两个历史时间步的速度场分别为：t={T0} : {U_T0_WRONG}，t={T1} : {U_T1_WRONG}。"
        "每个速度场数组包含 1024 个空间位置，它们在 0 到 1 区间上均匀分布。"
        "在数据清洗过程中发现，t={T0} 时第 {IDX} 个网格点的速度应由 {VAL_WRONG} 修正为 {VAL_TRUE}。"
        "请在使用修正后数据的基础上预测下一时间步的 1024 维速度场。"
    ),
    # 6
    (
        "一维 Burgers 方程的这条数值轨迹在历史时间步 {T0} 和 {T1} 的速度场记录为：{U_T0_WRONG}、{U_T1_WRONG}。"
        "空间方向采用 1024 个等间距网格点，将 0 到 1 区间均匀划分。"
        "需要指出的是，t={T0} 时第 {IDX} 个空间点的速度 {VAL_WRONG} 并非真实值，真实值应为 {VAL_TRUE}。"
        "请以真实值为准进行推断，并给出下一时间步的 1024 维速度场。"
    ),
    # 7
    (
        "这份一维 Burgers 方程数据中，记录员在时间步 {T0} 的第 {IDX} 个空间点上误写了一个速度值，目前表格中仍显示为 {VAL_WRONG}。"
        "所有空间点按照 [0,1] 区间均匀划分为 1024 个位置，对应数组 {U_T0_WRONG} 和 {U_T1_WRONG} 中的各个分量。"
        "实际上该位置的真实速度应该是 {VAL_TRUE}。"
        "请在考虑修正后数值的基础上，预测下一时间步的 1024 维速度场。"
    ),
    # 8
    (
        "对于该一维 Burgers 样本，我们最初的记录显示在 t={T0} 时的 1024 维速度场为 {U_T0_WRONG}，"
        "t={T1} 时的速度场为 {U_T1_WRONG}。"
        "其中 1024 个分量分别对应 0 到 1 区间上均匀分布的空间坐标。"
        "后来发现 t={T0} 时第 {IDX} 个空间点的速度 {VAL_WRONG} 有误，应当修正为 {VAL_TRUE}。"
        "请基于修正后的历史数据给出下一时间步的 1024 维解。"
    ),
    # 9
    (
        "在一维 Burgers 方程的这条轨迹中，我们给出 t={T0} 和 t={T1} 的两帧速度场：{U_T0_WRONG} 与 {U_T1_WRONG}。"
        "这些速度值是在空间方向上将 [0,1] 均匀划分为 1024 个网格点后，在每个点上计算得到的。"
        "校对后发现 t={T0} 时第 {IDX} 个空间点原速度 {VAL_WRONG} 需要替换为 {VAL_TRUE}，并将修正后的数值用于后续计算。"
        "请在这一基础上预测下一时间步 1024 个空间点上的速度场。"
    ),
    # 10
    (
        "Burgers 方程样本的一段历史解为：t={T0} : {U_T0_WRONG}，t={T1} : {U_T1_WRONG}。"
        "这里的 1024 个空间点在 0 到 1 区间内等距分布，因此每一维解都对应一个固定的空间位置。"
        "其中时间步 {T0} 第 {IDX} 个空间点原记录为 {VAL_WRONG}，实则应为 {VAL_TRUE}。"
        "请基于修正后的历史两帧，给出下一时间步在 1024 个空间点上的速度场。"
    ),
    # 11
    (
        "在这一一维 Burgers 样本的记录中，我们有 t={T0} 与 t={T1} 的两帧速度场：{U_T0_WRONG} 和 {U_T1_WRONG}。"
        "空间坐标在 [0,1] 上被均匀划分为 1024 个网格点，对应上述数组中的各个下标。"
        "经检查发现，t={T0} 的第 {IDX} 个空间点记录为 {VAL_WRONG}，正确速度应为 {VAL_TRUE}。"
        "请在以修正值为准的前提下，预测下一时间步 1024 个空间点上的速度场。"
    ),
    # 12
    (
        "这条一维 Burgers 方程数值轨迹中，历史时间步 {T0} 和 {T1} 的数据分别是 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "这些数据是在空间方向 0 到 1 区间均匀划分出的 1024 个网格点上计算得到。"
        "其中 t={T0} 第 {IDX} 个空间点曾被错误记录为 {VAL_WRONG}，实际上应为 {VAL_TRUE}。"
        "请基于修正后的数据，预测下一时间步的 1024 维速度场。"
    ),
    # 13
    (
        "对于这一一维 Burgers 方程样本，数组 {U_T0_WRONG} 和 {U_T1_WRONG} 分别给出了时间步 {T0} 与 {T1} 的 1024 维速度场。"
        "每个速度分量对应 [0,1] 区间上一点的数值，空间网格是等间距的。"
        "在 t={T0} 的第 {IDX} 个位置，原记录为 {VAL_WRONG}，经修正后应为 {VAL_TRUE}。"
        "请在修正后场值的基础上预测下一时间步 1024 个空间点上的速度场。"
    ),
    # 14
    (
        "一维 Burgers 方程的离散解通常定义在均匀网格上。这里我们有 t={T0} 和 t={T1} 的两帧解 {U_T0_WRONG} 与 {U_T1_WRONG}，"
        "对应 0 到 1 区间上等间距的 1024 个空间点。"
        "其中 t={T0} 的第 {IDX} 个点被记录为 {VAL_WRONG}，正确值应为 {VAL_TRUE}。"
        "请以修正后的解为基础，预测下一时间步的 1024 维速度场。"
    ),
    # 15
    (
        "在这一 Burgers 方程样本中，时间步 {T0} 的数组 {U_T0_WRONG} 和时间步 {T1} 的数组 {U_T1_WRONG} 都包含 1024 个空间维度。"
        "这些空间维度来自于对 [0,1] 区间的均匀划分。"
        "其中 t={T0} 的第 {IDX} 个位置记录 {VAL_WRONG} 有误，应被修正为 {VAL_TRUE}。"
        "请在考虑这一修正的前提下，推断下一时间步 1024 个空间点上的速度场。"
    ),
    # 16
    (
        "我们有一条一维 Burgers 轨迹，其历史帧为 t={T0} : {U_T0_WRONG} 与 t={T1} : {U_T1_WRONG}。"
        "空间方向在 0 到 1 区间上被均匀地离散为 1024 个网格点，每个数组分量对应一个网格上的速度。"
        "在 t={T0} 第 {IDX} 个网格位置上，原记录为 {VAL_WRONG}，真实值应为 {VAL_TRUE}。"
        "请在修正该值后预测下一时间步的 1024 维速度场。"
    ),
    # 17
    (
        "这一 Burgers 方程样本的两帧历史速度场 {U_T0_WRONG} 与 {U_T1_WRONG} 定义在同一个一维均匀网格上，该网格将 [0,1] 划分为 1024 个点。"
        "在 t={T0} 中，第 {IDX} 个空间点的速度记录为 {VAL_WRONG}，但应被更正为 {VAL_TRUE}。"
        "请使用修正后的历史数据，预测下一时间步在所有 1024 个网格点上的速度场。"
    ),
    # 18
    (
        "当前的一维 Burgers 模拟结果中，时间步 {T0} 和 {T1} 的速度场分别为 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "这些场值是在 0 到 1 区间上等间距布置的 1024 个空间点上计算得到的。"
        "检查发现 t={T0} 的第 {IDX} 个网格点记录 {VAL_WRONG} 有误，正确数值应为 {VAL_TRUE}。"
        "请在采用修正值的基础上，给出下一时间步在 1024 个空间点上的速度场。"
    ),
    # 19
    (
        "Burgers 方程的离散速度场 {U_T0_WRONG} 与 {U_T1_WRONG} 分别表示在时间步 {T0} 和 {T1} 时，"
        "在 1024 个空间网格点上的速度，这些网格点在 [0,1] 区间上均匀分布。"
        "其中 t={T0} 第 {IDX} 个点被错误地记录为 {VAL_WRONG}，而真实速度应为 {VAL_TRUE}。"
        "请修正该点之后，预测下一时间步 1024 维的速度场。"
    ),
    # 20
    (
        "我们有一条一维 Burgers 样本，其历史帧 t={T0} : {U_T0_WRONG}、t={T1} : {U_T1_WRONG} 定义在均匀网格上。"
        "空间方向从 0 到 1 均匀划分为 1024 个网格点。"
        "检测到 t={T0} 第 {IDX} 个空间点记录为 {VAL_WRONG}，实际应为 {VAL_TRUE}。"
        "请在修正该点数值后预测下一时间步的 1024 维速度场。"
    ),
    # 21
    (
        "在该一维 Burgers 数据的记录表中，时间步 {T0} 和 {T1} 的速度场数组 {U_T0_WRONG} 与 {U_T1_WRONG} 都有 1024 维。"
        "它们对应的是在 [0,1] 区间上等距选取的空间点。"
        "其中 t={T0} 的第 {IDX} 个元素 {VAL_WRONG} 被标记为错误，正确数值为 {VAL_TRUE}。"
        "请据此修正后预测下一时间步 1024 个空间点上的速度场。"
    ),
    # 22
    (
        "一维 Burgers 方程的这一样本的离散网格在 0 到 1 区间上均匀分布，共 1024 个空间点，"
        "在这些点上记录了 t={T0} 时的速度场 {U_T0_WRONG} 和 t={T1} 时的速度场 {U_T1_WRONG}。"
        "现在发现 t={T0} 的第 {IDX} 个点由 {VAL_WRONG} 修正为 {VAL_TRUE} 才准确。"
        "请在这一修正之后，预测下一时间步 1024 维的速度场。"
    ),
    # 23
    (
        "对于该 Burgers 方程样本，历史解 {U_T0_WRONG} 与 {U_T1_WRONG} 是在 1024 个等距空间节点上得到的，这些节点覆盖了 [0,1] 区间。"
        "在时间步 {T0} 中，第 {IDX} 个节点的观测速度写成了 {VAL_WRONG}，而实际数值应为 {VAL_TRUE}。"
        "请以修正后的历史解为基础，估计下一时间步在 1024 个空间点上的速度场。"
    ),
    # 24
    (
        "此一维 Burgers 方程数据记录使用了均匀的空间网格，将 [0,1] 区间划分为 1024 个点。"
        "在该网格上，我们有 t={T0} 时的速度场 {U_T0_WRONG} 和 t={T1} 时的速度场 {U_T1_WRONG}。"
        "检查发现 t={T0} 第 {IDX} 个点的速度 {VAL_WRONG} 应修正为 {VAL_TRUE}。"
        "请采用这一修正后，预测下一时间步的 1024 维速度场。"
    ),
    # 25
    (
        "这一条一维 Burgers 方程样本在 t={T0} 和 t={T1} 的数组 {U_T0_WRONG} 与 {U_T1_WRONG} 对应着 1024 个均匀布置的空间位置。"
        "其中 t={T0} 的第 {IDX} 个位置记录为 {VAL_WRONG}，真实速度值应为 {VAL_TRUE}。"
        "请更正该点后，推断下一时间步在所有 1024 个位置上的速度场分布。"
    ),
    # 26
    (
        "一维 Burgers 方程的场值在区间 [0,1] 上的 1024 个等距空间点处被记录为 {U_T0_WRONG}（时间 {T0}）和 {U_T1_WRONG}（时间 {T1}）。"
        "现在已知 t={T0} 的第 {IDX} 个位置的记录 {VAL_WRONG} 是错误的，正确速度应为 {VAL_TRUE}。"
        "请在这个修正基础上，估计下一时间步的 1024 维速度场。"
    ),
    # 27
    (
        "当前样本来自一维 Burgers 方程的数值求解，采用将 [0,1] 区间均匀划分为 1024 个网格点的空间离散策略。"
        "历史帧 t={T0} 和 t={T1} 的速度场记录为 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "其中 t={T0} 第 {IDX} 个网格的记录值为 {VAL_WRONG}，真实值为 {VAL_TRUE}。"
        "请据此修正后，预测下一时间步 1024 个空间点上的速度场。"
    ),
    # 28
    (
        "这一条 Burgers 方程样本的空间离散是沿 [0,1] 区间等距选取 1024 个点，在这些点上得到了 {U_T0_WRONG} 和 {U_T1_WRONG} 两帧场值。"
        "后续分析表明，t={T0} 第 {IDX} 个点被错误地记录为 {VAL_WRONG}，真实速度为 {VAL_TRUE}。"
        "在修正该点之后，请预测下一时间步的 1024 维速度场。"
    ),
    # 29
    (
        "在这条一维 Burgers 轨迹的记录中，空间方向已经被均匀划分成 1024 个小区间，对应的采样点构成数组 {U_T0_WRONG} 和 {U_T1_WRONG} 的下标。"
        "经校验，时间步 {T0} 的第 {IDX} 个采样点的速度 {VAL_WRONG} 是错误的，真实值为 {VAL_TRUE}。"
        "请修正该点后，给出下一时间步在 1024 个空间点上的速度场预测。"
    ),
    # 30
    (
        "一维 Burgers 方程的历史两帧速度场 {U_T0_WRONG} 和 {U_T1_WRONG} 都定义在 0 到 1 上均匀划分的 1024 个网格点上。"
        "其中 t={T0} 第 {IDX} 个点的值由 {VAL_WRONG} 修正为 {VAL_TRUE} 才正确。"
        "请基于修正后的两帧数据，估计下一时间步 1024 维的速度场。"
    ),
    # 31
    (
        "这条一维 Burgers 轨迹在两个时间步的场值记录为 {U_T0_WRONG} 和 {U_T1_WRONG}，"
        "它们均定义在 [0,1] 区间的 1024 个等距空间点上。"
        "在 t={T0} 的第 {IDX} 个点，原记录 {VAL_WRONG} 需要更正为 {VAL_TRUE}。"
        "请根据修正后的历史信息推理下一时间步的 1024 维速度场。"
    ),
    # 32
    (
        "我们使用均匀的 1024 点网格对空间进行离散，形成数组 {U_T0_WRONG} 与 {U_T1_WRONG} 中的索引。"
        "在时间步 {T0} 时，第 {IDX} 个网格点被错误记录为 {VAL_WRONG}，实际值为 {VAL_TRUE}。"
        "请在修正该点后，给出下一时间步在所有 1024 个网格点上的速度场。"
    ),
    # 33
    (
        "在一维 Burgers 方程的该样本中，t={T0} 和 t={T1} 的两帧速度场定义在 [0,1] 区间均匀划分的 1024 个空间点上。"
        "现在发现 t={T0} 第 {IDX} 个点的记录 {VAL_WRONG} 有误，应更正为 {VAL_TRUE}。"
        "请使用修正后的历史帧，预测下一时间步 1024 维速度场。"
    ),
    # 34
    (
        "这一 Burgers 样本的空间方向采用均匀网格离散，1024 个空间点覆盖 0 到 1 区间，并用来记录 {U_T0_WRONG} 与 {U_T1_WRONG} 两帧速度场。"
        "其中 t={T0} 第 {IDX} 个空间点的记录值 {VAL_WRONG} 被确认为错误，正确速度为 {VAL_TRUE}。"
        "请以修正后的历史数据为基础，预测下一时间步在全部 1024 个位置上的速度场。"
    ),
    # 35
    (
        "这条一维 Burgers 方程样本的网格在 [0,1] 区间上均匀分布，共 1024 个点，对应数组 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "其中 t={T0} 第 {IDX} 个点的记录值为 {VAL_WRONG}，真实速度为 {VAL_TRUE}。"
        "请更正该点后，给出下一时间步在 1024 个空间位置上的速度场预测。"
    ),
    # 36
    (
        "在这条 Burgers 样本的记录中，空间网格由 0 到 1 之间均匀间隔的 1024 个点组成，"
        "我们在这些点上记录了 t={T0} 时的速度 {U_T0_WRONG} 和 t={T1} 时的速度 {U_T1_WRONG}。"
        "检测到 t={T0} 的第 {IDX} 个点被写成 {VAL_WRONG}，而正确值为 {VAL_TRUE}。"
        "请修正该点后预测下一时间步的 1024 维速度场。"
    ),
    # 37
    (
        "对于这一维 Burgers 方程样本，使用等距网格对空间离散，得到 1024 个位置上的速度记录 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "有一个位置出现错误：t={T0} 第 {IDX} 个点记录为 {VAL_WRONG}，实际应为 {VAL_TRUE}。"
        "请以修正后的历史速度场为条件，预测下一时间步在全部 1024 个网格上的速度场。"
    ),
    # 38
    (
        "在该一维 Burgers 模拟中，我们沿 [0,1] 区间选取了 1024 个等距空间点，用以存储速度场 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "现得知 t={T0} 的第 {IDX} 个点记录为 {VAL_WRONG}，真实速度为 {VAL_TRUE}。"
        "请在这一更正基础上，估计下一时间步 1024 维的速度场。"
    ),
    # 39
    (
        "一维 Burgers 方程的历史两帧解 {U_T0_WRONG} 和 {U_T1_WRONG} 定义在同一套均匀网格上，该网格由 [0,1] 区间内的 1024 个点构成。"
        "其中 t={T0} 第 {IDX} 个点的记录速度 {VAL_WRONG} 需要更正为 {VAL_TRUE}。"
        "请基于修正后的历史帧，预测下一时间步在 1024 个空间位置上的速度场。"
    ),
    # 40
    (
        "在这条 Burgers 轨迹的记录中，空间方向已被划分为 1024 个等间距的节点，我们在这些节点上记录了 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "检查后发现 t={T0} 的第 {IDX} 个节点值从 {VAL_WRONG} 改为 {VAL_TRUE} 才正确。"
        "请在这个修正的基础上，推断下一时间步在所有 1024 个节点上的速度场。"
    ),
    # 41
    (
        "该一维 Burgers 样本采用均匀网格离散[0,1]区间，共 1024 个空间点，"
        "在这些点上我们得到 t={T0} 的速度场 {U_T0_WRONG} 和 t={T1} 的速度场 {U_T1_WRONG}。"
        "其中 t={T0} 第 {IDX} 个点的记录值 {VAL_WRONG} 不正确，正确速度应为 {VAL_TRUE}。"
        "请以修正后的历史场为输入，预测下一时间步 1024 维的速度场。"
    ),
    # 42
    (
        "我们在一维 Burgers 方程中选取了 1024 个等距空间点，并在这些点上记录了两个时间步的速度场 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "在时间步 {T0} 时，第 {IDX} 个点曾被记成 {VAL_WRONG}，后经验证应改为 {VAL_TRUE}。"
        "请基于修正后的数据，给出下一时间步 1024 个点的速度场预测。"
    ),
    # 43
    (
        "这一条 Burgers 方程样本的空间离散将 [0,1] 区间平均分割为 1024 个点，"
        "对应的速度场记录为 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "其中 t={T0} 第 {IDX} 个点的速度值从 {VAL_WRONG} 修正为 {VAL_TRUE} 才符合数值解。"
        "请在此修正基础上，估计下一时间步在 1024 个空间点上的速度场。"
    ),
    # 44
    (
        "沿着空间方向的一维均匀网格（0 到 1 区间，1024 个点）上，我们存储了 Burgers 方程在 t={T0} 和 t={T1} 时的速度场 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "通过检查发现，t={T0} 第 {IDX} 个网格点被错误标记为 {VAL_WRONG}，其真实速度应为 {VAL_TRUE}。"
        "请采用修正后的历史速度场，预测下一时间步 1024 维的速度场。"
    ),
    # 45
    (
        "一维 Burgers 方程的这一样本使用了均匀的 1024 点空间网格，对应数组 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "在网格点 t={T0} 的第 {IDX} 个位置，记录值为 {VAL_WRONG}，应当被更正为 {VAL_TRUE}。"
        "请以修正后的网格数据为条件，预测下一时间步的 1024 维速度场。"
    ),
    # 46
    (
        "该 Burgers 样本的两帧历史速度场以数组 {U_T0_WRONG}、{U_T1_WRONG} 给出，"
        "每个数组元素对应 [0,1] 区间上的一个等距空间点。"
        "其中 t={T0} 第 {IDX} 个点的记录 {VAL_WRONG} 被确认无效，真实值为 {VAL_TRUE}。"
        "请在修改该点后，估计下一时间步在 1024 个空间点上的速度场。"
    ),
    # 47
    (
        "我们使用均匀网格离散了一维 Burgers 方程的空间维度，共 1024 个点，在这些点上记录了 {U_T0_WRONG} 与 {U_T1_WRONG} 两帧速度场。"
        "经检查，时间步 {T0} 的第 {IDX} 个点原记录为 {VAL_WRONG}，真实速度应为 {VAL_TRUE}。"
        "请在更正此点后，对下一时间步的 1024 维速度场进行预测。"
    ),
    # 48
    (
        "本对流体速度演化的 Burgers 样本沿 [0,1] 区间选取了 1024 个等距空间位置，"
        "在这些位置上记录了 t={T0} 的速度 {U_T0_WRONG} 和 t={T1} 的速度 {U_T1_WRONG}。"
        "其中 t={T0} 第 {IDX} 个位置被误写为 {VAL_WRONG}，真实值为 {VAL_TRUE}。"
        "请在修正该位置后预测下一时间步在所有 1024 个位置上的速度场。"
    ),
    # 49
    (
        "这一 Burgers 方程样本的历史解 {U_T0_WRONG} 与 {U_T1_WRONG} 建立在均匀网格之上，该网格将 [0,1] 划分为 1024 个点。"
        "如今发现 t={T0} 第 {IDX} 个点的速度 {VAL_WRONG} 需要更正为 {VAL_TRUE}。"
        "请基于修正后的历史速度场，推断下一时间步在 1024 个空间点上的速度分布。"
    ),
    # 50
    (
        "在这条一维 Burgers 轨迹中，两个历史时间步的速度场 {U_T0_WRONG} 和 {U_T1_WRONG} 在同一空间网格上定义："
        "该网格由 [0,1] 区间的 1024 个等距点组成。"
        "其中时间 {T0} 的第 {IDX} 个点被记为 {VAL_WRONG}，正确速度应为 {VAL_TRUE}。"
        "请在采用修正值后预测下一时间步 1024 维的速度场。"
    ),
    # 51
    (
        "我们沿空间方向以均匀步长离散了一维 Burgers 方程，得到 1024 个空间点。"
        "在这些点上测得的历史速度场为 {U_T0_WRONG}（时间 {T0}）和 {U_T1_WRONG}（时间 {T1}）。"
        "检测到 t={T0} 第 {IDX} 个点的记录 {VAL_WRONG} 与真实速度 {VAL_TRUE} 不符。"
        "请使用修正后的速度场推断下一时间步的 1024 维结果。"
    ),
    # 52
    (
        "这一 Burgers 方程样本在均匀网格上记录了两帧速度场：{U_T0_WRONG} 和 {U_T1_WRONG}。"
        "网格将 [0,1] 区间划分成 1024 个等距点。"
        "在时间步 {T0} 中，第 {IDX} 个点的记录值为 {VAL_WRONG}，而实际值应为 {VAL_TRUE}。"
        "请更正该点后估计下一时间步在 1024 个点上的速度场。"
    ),
    # 53
    (
        "在这条一维 Burgers 数值实验中，场值在 [0,1] 上的 1024 个等距位置上评估，形成数组 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "有一处误差：时间步 {T0} 的第 {IDX} 个点记录为 {VAL_WRONG}，正确速度为 {VAL_TRUE}。"
        "请以真实速度为准，预测下一时间步 1024 维的场解。"
    ),
    # 54
    (
        "在该 Burgers 方程样本中，空间网格均匀划分为 1024 个点，并在每个点上记录了 t={T0} 和 t={T1} 的速度场 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "现在我们得知 t={T0} 第 {IDX} 个点的记录值 {VAL_WRONG} 实际应为 {VAL_TRUE}。"
        "请在修正这一点后，预测下一时间步在全部 1024 个网格点上的速度场。"
    ),
    # 55
    (
        "这一条 Burgers 方程轨迹的历史解基于统一的空间网格，该网格把 [0,1] 区间等距划分为 1024 个点。"
        "在这些点上，时间 {T0} 的速度场为 {U_T0_WRONG}，时间 {T1} 的速度场为 {U_T1_WRONG}。"
        "但 t={T0} 的第 {IDX} 个点的观测 {VAL_WRONG} 不正确，真实速度为 {VAL_TRUE}。"
        "请在修正后的网格基础上，估计下一时间步 1024 维速度场。"
    ),
    # 56
    (
        "对于该一维 Burgers 样本，我们在 0 到 1 区间均匀布置了 1024 个空间点，并在这些点上记录了 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "经核实，t={T0} 第 {IDX} 个点的记录速度 {VAL_WRONG} 需要更改为真实值 {VAL_TRUE}。"
        "请从修正后的速度场出发，预测下一时间步 1024 个空间点上的速度场。"
    ),
    # 57
    (
        "在这条一维 Burgers 轨迹中，历史帧 {U_T0_WRONG} 和 {U_T1_WRONG} 定义在同一个 1024 点的均匀空间网格上。"
        "其中 t={T0} 第 {IDX} 个网格点的记录值为 {VAL_WRONG}，而正确速度为 {VAL_TRUE}。"
        "请以修正数据为条件，推断下一时间步在 1024 个点上的速度场。"
    ),
    # 58
    (
        "我们对 Burgers 方程的解进行了空间均匀离散，在 0 到 1 区间上取 1024 个点记录场值 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "经分析可知，t={T0} 第 {IDX} 个点的记录 {VAL_WRONG} 是错误的，其真实速度应为 {VAL_TRUE}。"
        "请修正这一点后，预测下一时间步在所有 1024 个网格点上的速度场。"
    ),
    # 59
    (
        "一维 Burgers 方程的此样本利用统一的 1024 点空间网格描述速度场，历史数据存储为 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "在 t={T0} 中，第 {IDX} 个点被错误地记录为 {VAL_WRONG}，正确速度是 {VAL_TRUE}。"
        "请更正该点后，对下一时间步的 1024 维速度场进行预测。"
    ),
    # 60
    (
        "该一维 Burgers 方程样本采用的空间网格为 [0,1] 上均匀划分的 1024 个点，"
        "在这些点上分别记录了 t={T0} 时的速度场 {U_T0_WRONG} 和 t={T1} 时的速度场 {U_T1_WRONG}。"
        "现在已经确认 t={T0} 第 {IDX} 个点原记录为 {VAL_WRONG}，真实速度应该是 {VAL_TRUE}。"
        "请将该点修正为真实值后，预测下一时间步在所有 1024 个网格点上的速度场。"
    ),
]

# 让主逻辑统一用这两个名字
TEMPLATES_NORMAL = TEMPLATES_NORMAL_BURGERS
TEMPLATES_VAL_ERROR = TEMPLATES_VAL_ERROR_BURGERS

# ========== 4. 主逻辑：读取 hdf5 并生成 jsonl ==========
def main():
    num_normal = len(TEMPLATES_NORMAL)
    num_verr = len(TEMPLATES_VAL_ERROR)
    total_templates = num_normal + num_verr

    print(f"普通模板: {num_normal} 个, 数值纠错模板: {num_verr} 个, 总计: {total_templates} 个")

    if total_templates == 0:
        raise ValueError("没有任何模板，请先在 TEMPLATES_* 里填入中文模板")

    # 2) 打开 hdf5
    with h5py.File(H5_PATH, "r") as f:
        tensor = f["tensor"]
        N, T, X_raw = tensor.shape
        print("tensor shape:", tensor.shape)

        # 时间步索引：t0, t1, 下一帧
        T0_IDX = 0
        T1_IDX = 1
        T_NEXT_IDX = T1_IDX + 1  # 只预测下一帧
        assert T_NEXT_IDX < T, "时间步不足以取下一帧，请检查数据维度"

        # 每个模板用的样本索引
        base_indices = list(range(NUM_SAMPLES_PER_TEMPLATE))

        with OUTPUT_JSONL.open("w", encoding="utf-8") as fout:
            total_count = 0

            # ---------- 普通模板 ----------
            for tmpl in TEMPLATES_NORMAL:
                print("处理普通模板")
                for sample_idx in base_indices:
                    global_idx = sample_idx

                    # 取 t0, t1, t_next 三帧的原始数据
                    u_t0 = np.array(tensor[global_idx, T0_IDX, :], dtype=np.float32)
                    u_t1 = np.array(tensor[global_idx, T1_IDX, :], dtype=np.float32)
                    u_t2 = np.array(tensor[global_idx, T_NEXT_IDX, :], dtype=np.float32)

                    # 统一保留 6 位小数
                    u_t0 = np.round(u_t0, 6)
                    u_t1 = np.round(u_t1, 6)
                    u_t2 = np.round(u_t2, 6)

                    # label = [u(t0), u(t1)]
                    label_vec = np.concatenate([u_t0, u_t1]).tolist()
                    # completion = 下一帧 u(t2)
                    completion_vec = u_t2.tolist()

                    prompt = tmpl.format(
                        T0=T0_IDX,
                        T1=T1_IDX,
                        U_T0=array_to_str(u_t0),
                        U_T1=array_to_str(u_t1),
                    )

                    example = {
                        "prompt": prompt,
                        "label": label_vec,
                        "completion": completion_vec,
                    }
                    fout.write(json.dumps(example, ensure_ascii=False) + "\n")
                    total_count += 1

            # ---------- 数值纠错 模板 ----------
            for tmpl in TEMPLATES_VAL_ERROR:
                print("处理 数值纠错 模板")

                NX = tensor.shape[2]          # 现在还是 1024
                idx_for_template = random.randint(0, NX - 1)

                for sample_idx in base_indices:
                    global_idx = sample_idx

                    u_t0 = np.array(tensor[global_idx, T0_IDX, :], dtype=np.float32)
                    u_t1 = np.array(tensor[global_idx, T1_IDX, :], dtype=np.float32)
                    u_t2 = np.array(tensor[global_idx, T_NEXT_IDX, :], dtype=np.float32)

                    u_t0 = np.round(u_t0, 6)
                    u_t1 = np.round(u_t1, 6)
                    u_t2 = np.round(u_t2, 6)

                    idx = idx_for_template
                    val_true = float(u_t0[idx])
                    val_wrong = float(np.round(val_true + 0.1, 6))

                    u_t0_wrong = u_t0.copy()
                    u_t0_wrong[idx] = val_wrong
                    u_t1_wrong = u_t1

                    label_vec = np.concatenate([u_t0, u_t1]).tolist()
                    completion_vec = u_t2.tolist()

                    prompt = tmpl.format(
                        T0=T0_IDX,
                        T1=T1_IDX,
                        IDX=idx + 1,
                        VAL_WRONG=f"{val_wrong:.6f}",
                        VAL_TRUE=f"{val_true:.6f}",
                        U_T0_WRONG=array_to_str(u_t0_wrong),
                        U_T1_WRONG=array_to_str(u_t1_wrong),
                    )

                    example = {
                        "prompt": prompt,
                        "label": label_vec,
                        "completion": completion_vec,
                    }
                    fout.write(json.dumps(example, ensure_ascii=False) + "\n")
                    total_count += 1

        print(f"生成完成，总共写入 {total_count} 条样本到 {OUTPUT_JSONL}")


if __name__ == "__main__":
    main()
