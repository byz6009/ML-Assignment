import h5py
import json
import numpy as np
import random
from pathlib import Path


# ========== 1. 基本配置 ==========
H5_PATH = Path(r".\data\1D_Burgers_Sols_Nu1.0.hdf5")
OUTPUT_JSONL = Path("burgers_text2computation_full.jsonl")

# 历史两个时间步：这里用前两个时间点
T0_IDX = 0  # 第一个时间步
T1_IDX = 1  # 第二个时间步

# k（目标时间步）如何选：
# True  => 随机从 [T1_IDX+1, T-1] 里选一个，模拟多步滚动
# False => 固定用下一步（k = T1_IDX + 1），只做 one-step
USE_RANDOM_K = True

# 每种模板对应的样本条数：你说的是“每种模板 100 个样例”
NUM_SAMPLES_PER_TEMPLATE = 100



# ========== 2. 工具函数：数值数组转字符串 ==========

def array_to_str(arr: np.ndarray) -> str:
    """
    把一维数组变成 '0.123456, 0.234567, ...' 的字符串，
    用在 prompt 里展示 1024 个数。
    """
    return ", ".join(f"{v:.6f}" for v in arr)


# ========== 3. 文本模板：需要你在这里补满 100 条 ==========

# 3.1 普通模板（不纠错）
# 使用占位符：
# {T0}, {T1}, {Tk}, {U_T0}, {U_T1}
TEMPLATES_NORMAL = [
    # 1
    (
        "这是一条来自一维 Burgers 方程的数值模拟样本。在两个历史时间步上的一维速度场已经给出："
        "在时间步 {T0} 时，沿 1024 个空间点的流体速度为：{U_T0}；"
        "在时间步 {T1} 时，沿 1024 个空间点的流体速度为：{U_T1}。"
        "请根据这两个时间步的速度场信息，给出其下一时间步在 1024 个空间点上的速度场数值解。"
    ),
    # 2
    (
        "对于这一条一维 Burgers 方程轨迹，我们已经知晓在时间 {T0} 和 {T1} 上的流体速度场，"
        "它们分别在 1024 个空间网格上取样：t={T0} : {U_T0}；t={T1} : {U_T1}。"
        "请在只给定前两个时间帧的前提下，预测下一帧在 1024 个空间节点上的速度场分布。"
    ),
    # 3
    (
        "考虑一维 Burgers 方程的数值解。对当前这条样本，我们给出了两个已知时间步的速度场："
        "在 t={T0} 时的 1024 维速度为：{U_T0}；在 t={T1} 时的 1024 维速度为：{U_T1}。"
        "请利用这两帧数据，预测其下一时间步在 1024 个空间位置上的速度场。"
    ),
    # 4
    (
        "对一维 Burgers 方程的这条轨迹，我们已知在时间步 {T0} 和 {T1} 的解，分别是 1024 维速度数组：{U_T0} 和 {U_T1}。"
        "现在希望获得下一时间步的速度场。请根据已有的两帧历史信息，给出该时间步在全部 1024 个空间点上的速度分布。"
    ),
    # 5
    (
        "这是一个一维 Burgers 方程演化过程的数值结果。前两帧历史速度场分别对应时间 {T0} 和 {T1}，其在 1024 个空间位置上的取值为："
        "t={T0} : {U_T0}；t={T1} : {U_T1}。"
        "请据此推断下一时间步在 1024 个空间点上的速度场预测值。"
    ),
    # 6
    (
        "对于当前的一维 Burgers 方程样本，数值解在两个时刻 t={T0} 和 t={T1} 已经给出，"
        "两帧在 1024 个空间位置上的速度值分别列为：{U_T0} 和 {U_T1}。"
        "请在此基础上估计下一帧在 1024 个空间网格点上的速度场。"
    ),
    # 7
    (
        "我们对一维 Burgers 方程进行了离散求解。对于某条轨迹，已知 t={T0} 和 t={T1} 时刻的速度场解，"
        "在 1024 个网格点上的值分别为 {U_T0} 与 {U_T1}。"
        "现希望得到下一时间步在 1024 个空间位置上的速度场数值，请给出对应结果。"
    ),
    # 8
    (
        "在这一 Burgers 方程样本中，前两帧解已知：时间步 {T0} 对应的 1024 维速度数组为 {U_T0}，时间步 {T1} 对应的 1024 维速度数组为 {U_T1}。"
        "请在此基础上，预测下一帧在全部 1024 个空间点上的流体速度场。"
    ),
    # 9
    (
        "给定一维 Burgers 方程的数值轨迹，对当前样本而言，在时间步 {T0} 和 {T1} 上的速度场分别采样为 1024 维向量：{U_T0} 与 {U_T1}。"
        "请利用这两帧历史状态，预测下一时间步在 1024 个空间格点上的速度场分布。"
    ),
    # 10
    (
        "这是一个一维 Burgers 方程的时间序列样本。我们已经获得了两个历史时间步 {T0} 和 {T1} 上的解："
        "在 1024 个空间位置上的速度取值依次为 {U_T0} 和 {U_T1}。"
        "请给出该样本在下一时间步的 1024 维速度场解。"
    ),
    # 11
    (
        "在一维 Burgers 方程中，速度场随时间演化。对当前这条轨迹，时间步 {T0} 和 {T1} 的速度场已知，"
        "在 1024 个网格点上的速度值分别为 {U_T0} 与 {U_T1}。"
        "现请根据这两帧历史解，预测下一时间步在 1024 个格点上的速度场。"
    ),
    # 12
    (
        "考虑一维 Burgers 方程的离散模拟结果，对某条样本而言，我们已知在时间 {T0} 与 {T1} 上的 1024 维速度解：{U_T0} 和 {U_T1}。"
        "请在只给定这两帧信息的前提下，输出下一时间步的 1024 维速度场预测。"
    ),
    # 13
    (
        "对于这条一维 Burgers 方程样本，t={T0} 和 t={T1} 时刻的数值解在 1024 个空间点上已知："
        "t={T0} : {U_T0}；t={T1} : {U_T1}。"
        "请根据前两帧速度场解，预测下一时间步在 1024 个空间格点上的流体速度场。"
    ),
    # 14
    (
        "我们分析一维 Burgers 方程的这一条数值轨迹，已知两个历史时间步 {T0} 与 {T1} 上 1024 个网格点的解分别为 {U_T0} 和 {U_T1}。"
        "现在希望获得下一时间步的速度场，请输出该时间步在 1024 个空间点上的解。"
    ),
    # 15
    (
        "对当前的一维 Burgers 方程样本，数值解在两个时刻 t={T0} 和 t={T1} 已经给出，"
        "在 1024 个空间位置上的速度取值分别列为：{U_T0} 和 {U_T1}。"
        "请利用这两帧历史状态，预测下一帧在 1024 个空间点上的速度场。"
    ),
    # 16
    (
        "Burgers 方程中的速度场随时间演化并产生非线性效应。对这条样本，我们已知 t={T0} 与 t={T1} 的解分别为 1024 维向量：{U_T0}、{U_T1}。"
        "请基于这两帧数据，给出下一时间步在所有 1024 个空间位置上的速度场。"
    ),
    # 17
    (
        "针对该一维 Burgers 方程样本，在时间 {T0} 与 {T1} 上的空间速度分布已经通过数值方法求出，"
        "对应 1024 个网格点的取值为：{U_T0} 和 {U_T1}。"
        "如果我们希望得到下一时间步的速度场，请给出其在 1024 个空间点上的数值。"
    ),
    # 18
    (
        "下列数据来自一维 Burgers 方程的数值解：时间步 {T0} 的 1024 维速度场为 {U_T0}，时间步 {T1} 的 1024 维速度场为 {U_T1}。"
        "请根据这两帧历史速度场，推断下一帧在 1024 个空间点上的速度分布。"
    ),
    # 19
    (
        "对于给定的这条 Burgers 轨迹，我们在时间步 {T0} 和 {T1} 上的速度场观测结果分别为：{U_T0} 与 {U_T1}（共 1024 个空间点）。"
        "请利用这两帧历史解，给出下一时间步在 1024 个空间格点上的速度场数值解。"
    ),
    # 20
    (
        "我们掌握了当前 Burgers 方程样本在两个时间步上的速度分布：第一个时间步 {T0} 的 1024 个空间点速度为 {U_T0}，"
        "第二个时间步 {T1} 的 1024 个空间点速度为 {U_T1}。"
        "请预测下一时间步在所有 1024 个空间点上的速度场结果。"
    ),
    # 21
    (
        "对于该一维 Burgers 方程数值轨迹，我们已记录在时间步 {T0} 与 {T1} 的 1024 维速度解：在 1024 个空间点上的数值分别是 {U_T0} 和 {U_T1}。"
        "请给出该样本在下一时间步的 1024 维速度场。"
    ),
    # 22
    (
        "在此一维 Burgers 方程问题中，我们提供两帧历史解：t={T0} 和 t={T1} 的 1024 维速度场分别为 {U_T0} 与 {U_T1}。"
        "请在只使用这两帧信息的前提下，预测下一帧的速度场，在 1024 个空间离散点上的数值。"
    ),
    # 23
    (
        "下述是一维 Burgers 方程的一条轨迹片段。时间步 {T0} 的解在 1024 个空间点的速度为 {U_T0}，时间步 {T1} 的解为 {U_T1}。"
        "请利用这两帧初始速度场信息，预测下一时间步的 1024 维速度场。"
    ),
    # 24
    (
        "已知一维 Burgers 方程某条轨迹在 t={T0} 和 t={T1} 的数值解，"
        "在 1024 个空间位置上的速度值分别记录为：{U_T0}、{U_T1}。"
        "请给出此轨迹在下一时间步的 1024 个空间点上的速度场。"
    ),
    # 25
    (
        "对于这条 Burgers 样本，两个历史时间步 {T0} 和 {T1} 的速度场已经求出，长度为 1024 的向量分别为 {U_T0} 和 {U_T1}。"
        "请估计下一时间步对应的 1024 维速度场解。"
    ),
    # 26
    (
        "在一维 Burgers 方程的数值模拟中，我们只观测到了两个历史时刻的速度场：t={T0} 时的 1024 个数值为 {U_T0}，"
        "t={T1} 时的 1024 个数值为 {U_T1}。"
        "请在此基础上，预测下一时间步的 1024 个空间格点上的流体速度。"
    ),
    # 27
    (
        "对当前的 Burgers 方程轨迹，两个历史时间步的数值解已知，"
        "在 1024 个离散空间点上的结果分别为：{U_T0}（对应 {T0}），{U_T1}（对应 {T1}）。"
        "如果我们向前演化一步，请给出下一时间步的 1024 维速度场。"
    ),
    # 28
    (
        "这是一维 Burgers 方程的一个测试样本。我们给出 t={T0} 和 t={T1} 的数值解，"
        "即 {U_T0} 与 {U_T1}，每个包含 1024 个空间点的速度。"
        "现在请给出下一时间步在 1024 个空间点上的速度场预测。"
    ),
    # 29
    (
        "下面的数组描述了一维 Burgers 方程的两帧历史解：t={T0} 时的 1024 维速度为 {U_T0}，t={T1} 时的 1024 维速度为 {U_T1}。"
        "请根据这两帧数据，推断下一帧的 1024 维速度场。"
    ),
    # 30
    (
        "我们考虑一维 Burgers 方程的一段演化历史。两个已知时间步 {T0}、{T1} 的速度场已知，分别为长为 1024 的数组 {U_T0} 和 {U_T1}。"
        "现在希望推断下一时间步时 1024 个空间点上的速度场，请给出对应的预测结果。"
    ),
    # 31
    (
        "在 Burgers 方程中，速度场会随时间发生平移与变形。我们已观测到该样本在 t={T0} 和 t={T1} 的解，"
        "在 1024 个离散空间点上的速度值分别是 {U_T0} 和 {U_T1}。"
        "请基于这两帧历史解，预测下一帧在 1024 个空间格点上的速度场。"
    ),
    # 32
    (
        "这是一个一维 Burgers 方程的数值样本。输入条件是两个时间步 {T0} 与 {T1} 的速度场："
        "在 1024 个空间点上的速度序列分别为 {U_T0} 和 {U_T1}。"
        "请根据这两帧历史状态，预测下一时间步的 1024 维速度场。"
    ),
    # 33
    (
        "在这条 Burgers 轨迹中，时间步 {T0} 和 {T1} 的 1024 维速度场已经计算出来：{U_T0} 与 {U_T1}。"
        "请在此基础上，给出下一时间步在每个空间格点上的速度场预测。"
    ),
    # 34
    (
        "当前样本来自一维 Burgers 方程数值求解。已知在时间步 {T0} 的 1024 个空间点上速度为 {U_T0}，"
        "在时间步 {T1} 的 1024 个空间点上速度为 {U_T1}。"
        "请给出下一时间步的 1024 维速度场解。"
    ),
    # 35
    (
        "对于这一维 Burgers 方程样本，两个时间步 {T0} 与 {T1} 的解在 1024 个空间点上分别为 {U_T0} 与 {U_T1}。"
        "请你根据这两帧数据，预测下一时间步在 1024 个空间格点上的速度场。"
    ),
    # 36
    (
        "我们手头有一个 Burgers 方程数值结果，记录了 t={T0} 与 t={T1} 的 1024 维解：{U_T0} 和 {U_T1}。"
        "现在需要得到下一时间步的解。请基于这两帧历史状态输出该时间步在所有 1024 个空间位置上的速度场。"
    ),
    # 37
    (
        "下列两个数组给出了一维 Burgers 方程样本在时间步 {T0} 和 {T1} 时的数值解，各包含 1024 个空间离散点的速度：{U_T0} 与 {U_T1}。"
        "请根据这两帧历史状态，预测下一时间步在全部 1024 个空间点上的速度场。"
    ),
    # 38
    (
        "对于此 Burgers 方程样本，我们已经得到 t={T0} 和 t={T1} 的离散解，记为 {U_T0}、{U_T1}（长度均为 1024）。"
        "请外推到下一时间步，给出该时刻在 1024 个空间点上的速度数值解。"
    ),
    # 39
    (
        "以下是一维 Burgers 方程的一条离散轨迹，在时间步 {T0} 与 {T1} 的解分别为：{U_T0} 和 {U_T1}。"
        "请利用这两帧信息，预测下一帧的 1024 维速度场。"
    ),
    # 40
    (
        "我们正在研究一条一维 Burgers 方程的解轨迹。t={T0} 和 t={T1} 的速度场已经采样成两个 1024 维向量 {U_T0} 和 {U_T1}。"
        "请基于这两帧历史状态，给出下一时间步在所有 1024 个空间网格点上的速度场数值解。"
    ),
]


# 3.3 数值纠错模板
# 使用占位符：
# {T0}, {T1}, {Tk}, {IDX}, {VAL_WRONG}, {VAL_TRUE}, {U_T0_WRONG}, {U_T1_WRONG}
TEMPLATES_VAL_ERROR = [
    # 1
    (
        "这是一条一维 Burgers 方程样本。在时间步 {T0}，初始记录的 1024 个空间点速度场为：{U_T0_WRONG}。"
        "其中第 {IDX} 个空间网格点的速度被错误地写成了 {VAL_WRONG}，实际应该是 {VAL_TRUE}。"
        "在时间步 {T1}，速度场为：{U_T1_WRONG}。"
        "现以更正后的数值为准。请根据修正后的 t={T0} 与 t={T1} 两帧速度场信息，预测其下一时间步在 1024 个空间位置上的速度场。"
    ),
    # 2
    (
        "对一维 Burgers 方程的某条轨迹，我们给出了两个历史时间步的速度场："
        "t={T0} 时的 1024 个取值为：{U_T0_WRONG}，t={T1} 时的 1024 个取值为：{U_T1_WRONG}。"
        "在最初的记录中，时间步 {T0} 第 {IDX} 个空间点曾被记成 {VAL_WRONG}，经校对后确认应为 {VAL_TRUE}，上面的列表已经使用修正值。"
        "请在修正后的历史帧基础上，给出该样本在下一时间步中 1024 个空间离散点上的速度场预测结果。"
    ),
    # 3
    (
        "根据一维 Burgers 方程的数值解，我们得到 t={T0} 与 t={T1} 两个时间步上的速度场："
        "t={T0} : {U_T0_WRONG}；t={T1} : {U_T1_WRONG}。"
        "需要注意的是，t={T0} 时第 {IDX} 个空间网格点的观测受到干扰，原记录的速度 {VAL_WRONG} 应修正为 {VAL_TRUE}。"
        "请在采用修正后数据的前提下，预测下一时间步在 1024 个空间节点上的速度场。"
    ),
    # 4
    (
        "下列为一维 Burgers 方程在两个时间步的速度场数据：t={T0} : {U_T0_WRONG}，t={T1} : {U_T1_WRONG}。"
        "由于标定错误，t={T0} 时第 {IDX} 个空间点的速度 {VAL_WRONG} 实际上应为 {VAL_TRUE}。"
        "请利用修正后的历史两帧，给出下一时间步在 1024 个空间点上的速度场解。"
    ),
    # 5
    (
        "对该一维 Burgers 方程样本，两个历史时间步的速度场分别为：t={T0} : {U_T0_WRONG}，t={T1} : {U_T1_WRONG}。"
        "在数据清洗过程中发现，t={T0} 时第 {IDX} 个网格点的速度应由 {VAL_WRONG} 修正为 {VAL_TRUE}。"
        "请在使用修正后数据的基础上预测下一时间步的 1024 维速度场。"
    ),
    # 6
    (
        "一维 Burgers 方程的这条数值轨迹在历史时间步 {T0} 和 {T1} 的速度场记录为：{U_T0_WRONG}、{U_T1_WRONG}。"
        "需要指出的是，t={T0} 时第 {IDX} 个空间点的速度 {VAL_WRONG} 并非真实值，真实值应为 {VAL_TRUE}。"
        "请以真实速度为准进行推断，并给出下一时间步的 1024 维速度场。"
    ),
    # 7
    (
        "这份一维 Burgers 方程数据中，记录员在时间步 {T0} 的第 {IDX} 个空间点上误写了一个速度值，目前表格中仍显示为 {VAL_WRONG}。"
        "实际上该位置的真实速度应该是 {VAL_TRUE}。时间步 {T0} 与 {T1} 的 1024 维数组分别记录为：{U_T0_WRONG} 和 {U_T1_WRONG}。"
        "请在考虑修正后数值的基础上，预测下一时间步的 1024 维速度场。"
    ),
    # 8
    (
        "对于该一维 Burgers 方程样本，我们最初的记录显示在 t={T0} 时的 1024 维速度场为 {U_T0_WRONG}，"
        "t={T1} 时的速度场为 {U_T1_WRONG}。"
        "后来发现 t={T0} 时第 {IDX} 个空间点的速度 {VAL_WRONG} 有误，应当修正为 {VAL_TRUE}。"
        "请基于修正后的历史速度场数据给出下一时间步的 1024 维解。"
    ),
    # 9
    (
        "在一维 Burgers 方程的这条轨迹中，我们给出 t={T0} 和 t={T1} 的两帧速度场：{U_T0_WRONG} 与 {U_T1_WRONG}。"
        "校对后发现 t={T0} 时第 {IDX} 个空间点原记录速度 {VAL_WRONG} 需要替换为 {VAL_TRUE}，并将修正后的数值用于后续计算。"
        "请在这一基础上预测下一时间步 1024 个空间点上的速度场。"
    ),
    # 10
    (
        "对 Burgers 方程样本的一段历史解为：t={T0} : {U_T0_WRONG}，t={T1} : {U_T1_WRONG}。"
        "其中时间步 {T0} 第 {IDX} 个空间点原记的速度为 {VAL_WRONG}，实则应为 {VAL_TRUE}。"
        "请基于修正后的历史两帧，给出下一时间步在 1024 个空间点上的速度场。"
    ),
    # 11
    (
        "在该一维 Burgers 样本中，两帧历史数据 t={T0} 和 t={T1} 以 1024 个空间点记录速度场：{U_T0_WRONG} 与 {U_T1_WRONG}。"
        "由于传感器误差，t={T0} 中第 {IDX} 个点的观测速度 {VAL_WRONG} 被判定不可信，真实值应为 {VAL_TRUE}。"
        "请采用真实速度值进行推断，输出下一时间步的 1024 维速度场。"
    ),
    # 12
    (
        "下面的一维 Burgers 方程数据中，t={T0} 的 1024 维速度解为 {U_T0_WRONG}，t={T1} 的速度解为 {U_T1_WRONG}。"
        "其中 t={T0} 时第 {IDX} 个空间点的速度应由 {VAL_WRONG} 调整为 {VAL_TRUE}。"
        "请在此修正基础上，预测下一时间步的 1024 个空间点上的速度场。"
    ),
    # 13
    (
        "此一维 Burgers 方程样本的历史帧记录如下：时间 {T0} 的速度解（仍为原始记录）是 {U_T0_WRONG}，时间 {T1} 的速度解为 {U_T1_WRONG}。"
        "注意，t={T0} 时第 {IDX} 个空间点的真实速度并非 {VAL_WRONG}，而是 {VAL_TRUE}，这一更正信息需要在预测下一帧时考虑。"
    ),
    # 14
    (
        "当前的一维 Burgers 方程样本在时间步 {T0} 和 {T1} 上的数值解分别为：{U_T0_WRONG} 与 {U_T1_WRONG}。"
        "我们想要预测下一时间步的 1024 维速度场。"
        "另外，需要注意 t={T0} 时第 {IDX} 个空间点的速度应由 {VAL_WRONG} 修正为 {VAL_TRUE}，请在预测时采用修正后的数值。"
    ),
    # 15
    (
        "这一段一维 Burgers 数据包含两帧历史解：t={T0} 的数据为 {U_T0_WRONG}，t={T1} 的数据为 {U_T1_WRONG}。"
        "在数据清洗阶段发现，t={T0} 第 {IDX} 个空间点的速度从 {VAL_WRONG} 被修订为 {VAL_TRUE}。"
        "请基于清洗后的数据，预测下一时间步在 1024 个空间点上的速度场。"
    ),
    # 16
    (
        "我们在检查该一维 Burgers 方程样本时发现，时间步 {T0} 的第 {IDX} 个格点速度被手工录入为 {VAL_WRONG}，"
        "而实际计算结果应为 {VAL_TRUE}。原始速度数组为 {U_T0_WRONG}，t={T1} 的数组为 {U_T1_WRONG}。"
        "请在后续推理中视 {VAL_TRUE} 为真实值，给出下一时间步的 1024 维速度场。"
    ),
    # 17
    (
        "在一维 Burgers 方程的数值结果中，有一条样本的 t={T0} 帧在第 {IDX} 个空间点上的速度曾被记录为 {VAL_WRONG}。"
        "经过重新计算，该位置的正确速度应为 {VAL_TRUE}，其余网格点仍参考 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "请用修正后的速度数据来推断下一时间步的 1024 维解。"
    ),
    # 18
    (
        "对于该 Burgers 方程样本，我们给出两帧历史数据：时间步 {T0} 的 1024 维速度数组为 {U_T0_WRONG}，时间步 {T1} 的数组为 {U_T1_WRONG}。"
        "在 t={T0} 中，第 {IDX} 个空间位置的速度 {VAL_WRONG} 被证明是录入错误，正确值应为 {VAL_TRUE}。"
        "请据此预测下一时间步的 1024 维速度场。"
    ),
    # 19
    (
        "这一条一维 Burgers 方程轨迹中，t={T0} 与 t={T1} 的速度场值分别列为 {U_T0_WRONG}、{U_T1_WRONG}。"
        "经核对，t={T0} 时第 {IDX} 个空间点的原始记录速度 {VAL_WRONG} 需要更正为 {VAL_TRUE}。"
        "请在这种修正后的条件下给出下一时间步在 1024 个空间点上的速度场解。"
    ),
    # 20
    (
        "在该一维 Burgers 样本的原始记录中，t={T0} 的一个数据被误写为 {VAL_WRONG}（位置为第 {IDX} 个网格点）。"
        "修正后的真实速度应是 {VAL_TRUE}。t={T0} 和 t={T1} 的数组分别是 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "请在使用修正后的速度进行预测时，给出下一时间步的 1024 维速度场。"
    ),
    # 21
    (
        "我们查看这条一维 Burgers 方程的历史解时，发现 t={T0} 的第 {IDX} 个格点速度录成了 {VAL_WRONG}，实际应为 {VAL_TRUE}。"
        "其余格点值在 {U_T0_WRONG} 与 {U_T1_WRONG} 中已经正确给出。"
        "请以修正后的数据为条件，预测下一时间步在 1024 个空间点上的解。"
    ),
    # 22
    (
        "在对该一维 Burgers 样本进行数据校验时，t={T0} 第 {IDX} 个空间点的记录速度 {VAL_WRONG} 被标记为错误，"
        "正确值应当是 {VAL_TRUE}。时间步 {T0} 与 {T1} 的原始数组为 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "请采用修正后的速度值，推断下一时间步 1024 维的速度场。"
    ),
    # 23
    (
        "该一维 Burgers 方程样本包含两帧历史数据：t={T0} 的解 {U_T0_WRONG}，t={T1} 的解 {U_T1_WRONG}。"
        "其中在 t={T0} 时第 {IDX} 个空间点的速度原记录为 {VAL_WRONG}，而实测应为 {VAL_TRUE}。"
        "请在这一前提下预测下一时间步 1024 个空间点上的速度场。"
    ),
    # 24
    (
        "在该一维 Burgers 数据集中，某条样本的 t={T0} 帧存在一个录入错误：第 {IDX} 个点被写成 {VAL_WRONG}，"
        "实际速度应为 {VAL_TRUE}。完整数组为 {U_T0_WRONG}，对应 t={T1} 的数组为 {U_T1_WRONG}。"
        "请在修正此处数值后，预测下一时间步在 1024 个空间点上的速度场。"
    ),
    # 25
    (
        "对于当前这条一维 Burgers 方程轨迹，历史帧 t={T0} 与 t={T1} 的初始记录为：{U_T0_WRONG}、{U_T1_WRONG}。"
        "后续检查表明，t={T0} 的第 {IDX} 个空间点速度从 {VAL_WRONG} 修正为 {VAL_TRUE}。"
        "请在修正后的条件下给出下一时间步的 1024 维速度解。"
    ),
    # 26
    (
        "我们在处理一维 Burgers 方程轨迹数据时，发现 t={T0} 的某个格点速度录错了。"
        "原始数组为 {U_T0_WRONG}，其中第 {IDX} 个位置写成 {VAL_WRONG}，真实值应为 {VAL_TRUE}；"
        "t={T1} 的数组为 {U_T1_WRONG}。请据此预测下一时间步的 1024 维速度场。"
    ),
    # 27
    (
        "在这一 Burgers 样本中，时间步 {T0} 处的 1024 维解记录为 {U_T0_WRONG}，时间步 {T1} 处的解记录为 {U_T1_WRONG}。"
        "但 t={T0} 第 {IDX} 个空间点的速度 {VAL_WRONG} 已被证明不正确，正确值是 {VAL_TRUE}。"
        "请在预测下一时间步时，将该位置的数值视为 {VAL_TRUE}，并给出整条 1024 维速度场。"
    ),
    # 28
    (
        "此一维 Burgers 轨迹的 t={T0} 帧中，单个空间点存在记录错误：第 {IDX} 个点原记为 {VAL_WRONG}，应改为 {VAL_TRUE}。"
        "t={T0} 与 t={T1} 的数组在文件中显示为 {U_T0_WRONG}、{U_T1_WRONG}。"
        "请在修正该点数值之后，预测下一时间步的 1024 维速度场。"
    ),
    # 29
    (
        "对于这一条一维 Burgers 方程样本，两帧历史数据 t={T0} 和 t={T1} 以数组 {U_T0_WRONG} 与 {U_T1_WRONG} 形式提供。"
        "其间，t={T0} 的第 {IDX} 个空间点的记录速度 {VAL_WRONG} 已被确认应替换为 {VAL_TRUE}。"
        "请给出在此修正之后的下一时间步 1024 维速度解。"
    ),
    # 30
    (
        "在该一维 Burgers 样本的原始记录中，t={T0} 的一个速度数据被误写为 {VAL_WRONG}（位于第 {IDX} 个网格点）。"
        "经查证，正确速度应当是 {VAL_TRUE}。t={T0} 和 t={T1} 的数组分别为 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "请在使用修正后的值进行预测时，给出下一时间步的 1024 维速度场。"
    ),
    # 31
    (
        "在检查 Burgers 方程的一条轨迹时，我们发现 t={T0} 帧有一个元素录入不正确：第 {IDX} 个空间点原速度为 {VAL_WRONG}，"
        "实际数值应为 {VAL_TRUE}。两帧数据数组为 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "请在这一修正基础上，预测下一时间步的 1024 维速度解。"
    ),
    # 32
    (
        "对这一维 Burgers 样本而言，t={T0} 的 1024 维数据 {U_T0_WRONG} 中有一个点记录错误，"
        "第 {IDX} 个位置由 {VAL_WRONG} 修正为 {VAL_TRUE}。t={T1} 的数据为 {U_T1_WRONG}。"
        "请在修正这个速度点后，给出下一时间步的完整 1024 维速度场。"
    ),
    # 33
    (
        "在对一维 Burgers 速度场做质量检查时，我们发现在 t={T0} 帧中，第 {IDX} 个空间点的记录 {VAL_WRONG} 与理论值不符。"
        "正确值应为 {VAL_TRUE}。t={T0}、t={T1} 的数组为 {U_T0_WRONG}、{U_T1_WRONG}。"
        "请以修正后的速度为准，预测下一时间步在 1024 个空间点上的解。"
    ),
    # 34
    (
        "这一段 Burgers 模拟的历史数据包括时间步 {T0} 和 {T1} 的 1024 维速度解：{U_T0_WRONG} 与 {U_T1_WRONG}。"
        "其中 t={T0} 第 {IDX} 个格点速度应由 {VAL_WRONG} 改为 {VAL_TRUE}，其余数值保持不变。"
        "请基于修正后的数据给出下一时间步的 1024 维速度场。"
    ),
    # 35
    (
        "在下述一维 Burgers 方程样本中，t={T0} 帧的数组 {U_T0_WRONG} 中有一个异常速度值：第 {IDX} 个位置为 {VAL_WRONG}，"
        "经查证应为 {VAL_TRUE}。t={T1} 的数组为 {U_T1_WRONG}。"
        "请在修正该异常速度后，预测下一时间步的 1024 维速度解。"
    ),
    # 36
    (
        "该一维 Burgers 样本来自数值模拟，历史两帧 t={T0} 和 t={T1} 的解分别记为 {U_T0_WRONG}、{U_T1_WRONG}。"
        "随后发现 t={T0} 第 {IDX} 个网格点的速度存在录入错误，从 {VAL_WRONG} 调整为 {VAL_TRUE}。"
        "请在后续推理中采用修正后的数据，输出下一时间步的 1024 维速度场。"
    ),
    # 37
    (
        "在一维 Burgers 方程的这一条轨迹中，t={T0} 的观测数组 {U_T0_WRONG} 在第 {IDX} 个位置写成 {VAL_WRONG}，"
        "但根据重新计算，实际应为 {VAL_TRUE}。另一帧 t={T1} 的数组为 {U_T1_WRONG}。"
        "请根据修正后的 t={T0} 与 t={T1}，预测下一时间步的 1024 维速度场。"
    ),
    # 38
    (
        "对该一维 Burgers 样本进行清洗时，我们发现 t={T0} 第 {IDX} 个空间点的 speed 值存在笔误："
        "原记为 {VAL_WRONG}，应更正为 {VAL_TRUE}。t={T0} 的整段数组为 {U_T0_WRONG}，t={T1} 为 {U_T1_WRONG}。"
        "请在使用修正值的前提下预测下一时间步的速度场。"
    ),
    # 39
    (
        "这条一维 Burgers 方程轨迹有两帧历史数据，分别是时间步 {T0} 和 {T1} 上的 1024 维速度场解：{U_T0_WRONG}、{U_T1_WRONG}。"
        "其中 t={T0} 的第 {IDX} 个空间点原本错误写成 {VAL_WRONG}，真实速度值为 {VAL_TRUE}。"
        "请以真实速度为准，给出下一时间步的 1024 维数值解。"
    ),
    # 40
    (
        "在这一维 Burgers 方程的历史记录中，时间步 {T0} 的数组 {U_T0_WRONG} 中第 {IDX} 个位置取值为 {VAL_WRONG}，"
        "但后续重新计算表明该速度应修正为 {VAL_TRUE}。另一帧 t={T1} 的数组为 {U_T1_WRONG}。"
        "请将修正后的数据作为条件，输出下一时间步在 1024 个空间点上的速度场。"
    ),
    # 41
    (
        "在这一 Burgers 轨迹中，我们给出时间步 {T0} 的初始记录 {U_T0_WRONG} 和时间步 {T1} 的记录 {U_T1_WRONG}。"
        "其中 t={T0} 的第 {IDX} 个空间点的速度由 {VAL_WRONG} 更正为 {VAL_TRUE}。"
        "请利用修正后的历史帧，预测下一时间步的 1024 维速度场。"
    ),
    # 42
    (
        "对于该一维 Burgers 方程样本，历史帧 t={T0} 的数组 {U_T0_WRONG} 中有一个错误速度值：第 {IDX} 个位置的记录为 {VAL_WRONG}，"
        "正确值应为 {VAL_TRUE}。t={T1} 的数组 {U_T1_WRONG} 被认为是可靠的。"
        "请据此构造正确的历史输入，并给出下一时间步在 1024 个空间点上的速度解。"
    ),
    # 43
    (
        "在一次人工录入中，一维 Burgers 方程的这条样本在时间步 {T0} 的第 {IDX} 个格点上被误写为 {VAL_WRONG}。"
        "正确的速度值应为 {VAL_TRUE}，数组 {U_T0_WRONG} 与 {U_T1_WRONG} 中的其他元素保持不变。"
        "请结合这一修正，预测下一时间步 1024 个空间节点上的速度场。"
    ),
    # 44
    (
        "该一维 Burgers 样本的历史数据如下：t={T0} 帧为 {U_T0_WRONG}，t={T1} 帧为 {U_T1_WRONG}。"
        "经核查，t={T0} 的第 {IDX} 个空间位置的速度应由 {VAL_WRONG} 改为 {VAL_TRUE}。"
        "请在以修正速度为准的前提下，估计下一时间步 1024 维的解向量。"
    ),
    # 45
    (
        "在对流体速度进行模拟的一维 Burgers 数据中，t={T0} 的数组 {U_T0_WRONG} 中存在一个异常记录，第 {IDX} 个点写作 {VAL_WRONG}，"
        "正确数值为 {VAL_TRUE}。时间步 {T1} 的数组 {U_T1_WRONG} 无误。"
        "请使用修正后的历史数据，预测下一时间步的 1024 个空间点上的速度场。"
    ),
    # 46
    (
        "一维 Burgers 方程的这一条样本在历史时间步 {T0} 和 {T1} 的数据分别为：{U_T0_WRONG}、{U_T1_WRONG}。"
        "其中 t={T0} 第 {IDX} 个空间点记录为 {VAL_WRONG}，真实速度应为 {VAL_TRUE}。"
        "请基于修正后的历史帧预测下一时间步 1024 维速度场。"
    ),
    # 47
    (
        "在整理这条一维 Burgers 方程样本时，我们发现时间步 {T0} 的第 {IDX} 个空间点的记录速度 {VAL_WRONG} 与模型输出不一致。"
        "重新计算给出的正确值是 {VAL_TRUE}。t={T0} 的数组为 {U_T0_WRONG}，t={T1} 的数组为 {U_T1_WRONG}。"
        "请以 {VAL_TRUE} 为准，并据此推断下一时间步的 1024 维速度解。"
    ),
    # 48
    (
        "这一 Burgers 轨迹的历史数据中，t={T0} 的 1024 维速度场为 {U_T0_WRONG}，t={T1} 的速度场为 {U_T1_WRONG}。"
        "报告指出 t={T0} 的第 {IDX} 个点原记录 {VAL_WRONG} 有误，应改为 {VAL_TRUE}。"
        "请在考虑该修正的条件下预测下一时间步 1024 个空间点上的速度场。"
    ),
    # 49
    (
        "在一维 Burgers 方程的模拟输出中，这条样本的 t={T0} 和 t={T1} 两帧记录分别为：{U_T0_WRONG} 与 {U_T1_WRONG}。"
        "其中 t={T0} 第 {IDX} 个空间点曾被记为 {VAL_WRONG}，修正后应为 {VAL_TRUE}。"
        "请在此基础上给出下一时间步在 1024 个空间点上的速度场预测。"
    ),
    # 50
    (
        "这一条样本对应一维 Burgers 方程的一段时间演化过程。历史帧 t={T0} 的数据 {U_T0_WRONG} 中第 {IDX} 个位置取值为 {VAL_WRONG}，"
        "但校核结果表明该速度应为 {VAL_TRUE}。t={T1} 的数据为 {U_T1_WRONG}。"
        "请修正该点后，预测下一时间步 1024 维的速度解向量。"
    ),
    # 51
    (
        "在一维 Burgers 方程的数据集中，这条轨迹在时间步 {T0} 被记录为 {U_T0_WRONG}，在时间步 {T1} 被记录为 {U_T1_WRONG}。"
        "其中 t={T0} 的第 {IDX} 个空间点记录为 {VAL_WRONG}，实际速度应为 {VAL_TRUE}。"
        "请以真实值为准构造历史输入，并给出下一时间步 1024 个格点上的速度解。"
    ),
    # 52
    (
        "该一维 Burgers 样本包含两帧历史解 t={T0} 和 t={T1}，1024 维数组分别为 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "在 t={T0} 上，第 {IDX} 个空间点被错误记录为 {VAL_WRONG}，应修正为 {VAL_TRUE}。"
        "请在修正这一点后预测下一时间步在所有 1024 个空间点上的速度场。"
    ),
    # 53
    (
        "对于这一条一维 Burgers 方程轨迹，历史数据 t={T0} 与 t={T1} 分别为 {U_T0_WRONG} 和 {U_T1_WRONG}。"
        "t={T0} 的第 {IDX} 个空间位置原速度 {VAL_WRONG} 已被确认是错误记录，正确值为 {VAL_TRUE}。"
        "请使用修正后的历史解来推断下一时间步 1024 维速度场。"
    ),
    # 54
    (
        "在这条一维 Burgers 样本的原始数据中，t={T0} 的数组 {U_T0_WRONG} 中有一项速度录错，"
        "位于第 {IDX} 个空间点，其原始记录为 {VAL_WRONG}，实际应为 {VAL_TRUE}。t={T1} 的数组为 {U_T1_WRONG}。"
        "请在更正该值后预测下一时间步的 1024 维速度解。"
    ),
    # 55
    (
        "当前一维 Burgers 样本的两帧历史解为：t={T0} : {U_T0_WRONG}，t={T1} : {U_T1_WRONG}。"
        "后续检查发现 t={T0} 的第 {IDX} 个空间点速度 {VAL_WRONG} 与预期不符，正确应为 {VAL_TRUE}。"
        "请以修正值为前提，预测下一时间步在 1024 个空间点的速度场。"
    ),
    # 56
    (
        "这一段 Burgers 速度场历史数据中，时间步 {T0} 和 {T1} 的 1024 维数组分别记录为 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "然而 t={T0} 第 {IDX} 个点的速度 {VAL_WRONG} 已被发现是录入错误，正确值为 {VAL_TRUE}。"
        "请在修正该点后，给出下一时间步的 1024 维速度场。"
    ),
    # 57
    (
        "对这条一维 Burgers 方程轨迹而言，我们有两帧历史记录：t={T0} 的数据 {U_T0_WRONG}，t={T1} 的数据 {U_T1_WRONG}。"
        "其中 t={T0} 第 {IDX} 个空间点的速度由 {VAL_WRONG} 改为 {VAL_TRUE} 才是正确的输入。"
        "请基于修正后的历史帧，预测下一时间步在 1024 个空间位置上的速度场。"
    ),
    # 58
    (
        "在检查一维 Burgers 方程的这条样本时，我们发现 t={T0} 时第 {IDX} 个空间点记录为 {VAL_WRONG}，"
        "而模型计算表明正确速度应为 {VAL_TRUE}。t={T0} 和 t={T1} 的数组目前仍显示为 {U_T0_WRONG} 与 {U_T1_WRONG}。"
        "请将 {VAL_TRUE} 视为该点真实速度，并据此预测下一时间步的 1024 维速度场。"
    ),
    # 59
    (
        "对于这条一维 Burgers 速度轨迹，历史帧的初始记录为 t={T0} : {U_T0_WRONG}，t={T1} : {U_T1_WRONG}。"
        "在 t={T0} 中，第 {IDX} 个空间点的原始记录 {VAL_WRONG} 需更正为 {VAL_TRUE} 才符合实际。"
        "请在这一更正之上，推断下一时间步 1024 个空间点上的速度场。"
    ),
    # 60
    (
        "该一维 Burgers 方程样本的历史两帧数据包含若干记录误差，其中最关键的是 t={T0} 第 {IDX} 个空间点的速度，"
        "原记录为 {VAL_WRONG}，正确值应当是 {VAL_TRUE}。数组 {U_T0_WRONG} 与 {U_T1_WRONG} 给出了其他空间点的历史信息。"
        "请在修正该误差后，预测下一时间步 1024 维的速度场解。"
    ),
]

# ========== 4. 主逻辑：读取 hdf5 并生成 jsonl ==========
def main():
    num_normal = len(TEMPLATES_NORMAL)
    num_verr = len(TEMPLATES_VAL_ERROR)
    total_templates = num_normal + num_verr

    print(f"普通模板: {num_normal} 个, 数值纠错模板: {num_verr} 个, 总计: {total_templates} 个")

    if total_templates == 0:
        raise ValueError("没有任何模板，请先在 TEMPLATES_* 里填入中文模板")

    # 2) 打开 hdf5
    with h5py.File(H5_PATH, "r") as f:
        tensor = f["tensor"]
        N, T, X_raw = tensor.shape
        print("tensor shape:", tensor.shape)

        # 时间步索引：t0, t1, 下一帧
        T0_IDX = 0
        T1_IDX = 1
        T_NEXT_IDX = T1_IDX + 1  # 只预测下一帧
        assert T_NEXT_IDX < T, "时间步不足以取下一帧，请检查数据维度"

        # 每个模板用的样本索引
        base_indices = list(range(NUM_SAMPLES_PER_TEMPLATE))

        with OUTPUT_JSONL.open("w", encoding="utf-8") as fout:
            total_count = 0

            # ---------- 普通模板 ----------
            for tmpl in TEMPLATES_NORMAL:
                print("处理普通模板")
                for sample_idx in base_indices:
                    global_idx = sample_idx

                    # 取 t0, t1, t_next 三帧的原始数据
                    u_t0 = np.array(tensor[global_idx, T0_IDX, :], dtype=np.float32)
                    u_t1 = np.array(tensor[global_idx, T1_IDX, :], dtype=np.float32)
                    u_t2 = np.array(tensor[global_idx, T_NEXT_IDX, :], dtype=np.float32)

                    # 统一保留 6 位小数
                    u_t0 = np.round(u_t0, 6)
                    u_t1 = np.round(u_t1, 6)
                    u_t2 = np.round(u_t2, 6)

                    # label = [u(t0), u(t1)]
                    label_vec = np.concatenate([u_t0, u_t1]).tolist()
                    # completion = 下一帧 u(t2)
                    completion_vec = u_t2.tolist()

                    prompt = tmpl.format(
                        T0=T0_IDX,
                        T1=T1_IDX,
                        U_T0=array_to_str(u_t0),
                        U_T1=array_to_str(u_t1),
                    )

                    example = {
                        "prompt": prompt,
                        "label": label_vec,
                        "completion": completion_vec,
                    }
                    fout.write(json.dumps(example, ensure_ascii=False) + "\n")
                    total_count += 1

            # ---------- 数值纠错 模板 ----------
            for tmpl in TEMPLATES_VAL_ERROR:
                print("处理 数值纠错 模板")

                NX = tensor.shape[2]          # 现在还是 1024
                idx_for_template = random.randint(0, NX - 1)

                for sample_idx in base_indices:
                    global_idx = sample_idx

                    u_t0 = np.array(tensor[global_idx, T0_IDX, :], dtype=np.float32)
                    u_t1 = np.array(tensor[global_idx, T1_IDX, :], dtype=np.float32)
                    u_t2 = np.array(tensor[global_idx, T_NEXT_IDX, :], dtype=np.float32)

                    u_t0 = np.round(u_t0, 6)
                    u_t1 = np.round(u_t1, 6)
                    u_t2 = np.round(u_t2, 6)

                    idx = idx_for_template
                    val_true = float(u_t0[idx])
                    val_wrong = float(np.round(val_true + 0.1, 6))

                    u_t0_wrong = u_t0.copy()
                    u_t0_wrong[idx] = val_wrong
                    u_t1_wrong = u_t1

                    label_vec = np.concatenate([u_t0, u_t1]).tolist()
                    completion_vec = u_t2.tolist()

                    prompt = tmpl.format(
                        T0=T0_IDX,
                        T1=T1_IDX,
                        IDX=idx + 1,
                        VAL_WRONG=f"{val_wrong:.6f}",
                        VAL_TRUE=f"{val_true:.6f}",
                        U_T0_WRONG=array_to_str(u_t0_wrong),
                        U_T1_WRONG=array_to_str(u_t1_wrong),
                    )

                    example = {
                        "prompt": prompt,
                        "label": label_vec,
                        "completion": completion_vec,
                    }
                    fout.write(json.dumps(example, ensure_ascii=False) + "\n")
                    total_count += 1

        print(f"生成完成，总共写入 {total_count} 条样本到 {OUTPUT_JSONL}")


if __name__ == "__main__":
    main()
